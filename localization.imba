# Emoji flags mapping - comprehensive list by region
export const flags = {
	# Europe
	'gb': 'ğŸ‡¬ğŸ‡§', 'us': 'ğŸ‡ºğŸ‡¸', 'ru': 'ğŸ‡·ğŸ‡º', 'de': 'ğŸ‡©ğŸ‡ª', 'fr': 'ğŸ‡«ğŸ‡·',
	'es': 'ğŸ‡ªğŸ‡¸', 'it': 'ğŸ‡®ğŸ‡¹', 'nl': 'ğŸ‡³ğŸ‡±', 'pl': 'ğŸ‡µğŸ‡±', 'ua': 'ğŸ‡ºğŸ‡¦',
	'cz': 'ğŸ‡¨ğŸ‡¿', 'gr': 'ğŸ‡¬ğŸ‡·', 'hu': 'ğŸ‡­ğŸ‡º', 'ro': 'ğŸ‡·ğŸ‡´', 'se': 'ğŸ‡¸ğŸ‡ª',
	'no': 'ğŸ‡³ğŸ‡´', 'dk': 'ğŸ‡©ğŸ‡°', 'fi': 'ğŸ‡«ğŸ‡®', 'pt': 'ğŸ‡µğŸ‡¹', 'ie': 'ğŸ‡®ğŸ‡ª',
	'be': 'ğŸ‡§ğŸ‡ª', 'at': 'ğŸ‡¦ğŸ‡¹', 'ch': 'ğŸ‡¨ğŸ‡­', 'sk': 'ğŸ‡¸ğŸ‡°', 'bg': 'ğŸ‡§ğŸ‡¬',
	'hr': 'ğŸ‡­ğŸ‡·', 'rs': 'ğŸ‡·ğŸ‡¸', 'si': 'ğŸ‡¸ğŸ‡®', 'lt': 'ğŸ‡±ğŸ‡¹', 'lv': 'ğŸ‡±ğŸ‡»',
	'ee': 'ğŸ‡ªğŸ‡ª', 'is': 'ğŸ‡®ğŸ‡¸', 'lu': 'ğŸ‡±ğŸ‡º', 'mt': 'ğŸ‡²ğŸ‡¹', 'cy': 'ğŸ‡¨ğŸ‡¾',
	'ba': 'ğŸ‡§ğŸ‡¦', 'mk': 'ğŸ‡²ğŸ‡°', 'al': 'ğŸ‡¦ğŸ‡±', 'md': 'ğŸ‡²ğŸ‡©', 'me': 'ğŸ‡²ğŸ‡ª',
	'by': 'ğŸ‡§ğŸ‡¾', 'ru': 'ğŸ‡·ğŸ‡º', 'ge': 'ğŸ‡¬ğŸ‡ª', 'am': 'ğŸ‡¦ğŸ‡²', 'az': 'ğŸ‡¦ğŸ‡¿',
	
	# Asia
	'cn': 'ğŸ‡¨ğŸ‡³', 'jp': 'ğŸ‡¯ğŸ‡µ', 'kr': 'ğŸ‡°ğŸ‡·', 'in': 'ğŸ‡®ğŸ‡³', 'id': 'ğŸ‡®ğŸ‡©',
	'th': 'ğŸ‡¹ğŸ‡­', 'vn': 'ğŸ‡»ğŸ‡³', 'ph': 'ğŸ‡µğŸ‡­', 'sg': 'ğŸ‡¸ğŸ‡¬', 'my': 'ğŸ‡²ğŸ‡¾',
	'hk': 'ğŸ‡­ğŸ‡°', 'tw': 'ğŸ‡¹ğŸ‡¼', 'pk': 'ğŸ‡µğŸ‡°', 'bd': 'ğŸ‡§ğŸ‡©', 'lk': 'ğŸ‡±ğŸ‡°',
	'kh': 'ğŸ‡°ğŸ‡­', 'la': 'ğŸ‡±ğŸ‡¦', 'mm': 'ğŸ‡²ğŸ‡²', 'bn': 'ğŸ‡§ğŸ‡³', 'mo': 'ğŸ‡²ğŸ‡´',
	'mn': 'ğŸ‡²ğŸ‡³', 'np': 'ğŸ‡³ğŸ‡µ', 'bt': 'ğŸ‡§ğŸ‡¹', 'mv': 'ğŸ‡²ğŸ‡»', 'kz': 'ğŸ‡°ğŸ‡¿',
	'uz': 'ğŸ‡ºğŸ‡¿', 'tm': 'ğŸ‡¹ğŸ‡²', 'kg': 'ğŸ‡°ğŸ‡¬', 'tj': 'ğŸ‡¹ğŸ‡¯', 'af': 'ğŸ‡¦ğŸ‡«',
	
	# Middle East
	'tr': 'ğŸ‡¹ğŸ‡·', 'il': 'ğŸ‡®ğŸ‡±', 'ae': 'ğŸ‡¦ğŸ‡ª', 'sa': 'ğŸ‡¸ğŸ‡¦', 'qa': 'ğŸ‡¶ğŸ‡¦',
	'kw': 'ğŸ‡°ğŸ‡¼', 'bh': 'ğŸ‡§ğŸ‡­', 'om': 'ğŸ‡´ğŸ‡²', 'jo': 'ğŸ‡¯ğŸ‡´', 'lb': 'ğŸ‡±ğŸ‡§',
	'iq': 'ğŸ‡®ğŸ‡¶', 'ir': 'ğŸ‡®ğŸ‡·', 'sy': 'ğŸ‡¸ğŸ‡¾', 'ye': 'ğŸ‡¾ğŸ‡ª', 'ps': 'ğŸ‡µğŸ‡¸',
	
	# Americas
	'br': 'ğŸ‡§ğŸ‡·', 'mx': 'ğŸ‡²ğŸ‡½', 'ca': 'ğŸ‡¨ğŸ‡¦', 'ar': 'ğŸ‡¦ğŸ‡·', 'cl': 'ğŸ‡¨ğŸ‡±',
	'co': 'ğŸ‡¨ğŸ‡´', 'pe': 'ğŸ‡µğŸ‡ª', 've': 'ğŸ‡»ğŸ‡ª', 'ec': 'ğŸ‡ªğŸ‡¨', 'uy': 'ğŸ‡ºğŸ‡¾',
	'py': 'ğŸ‡µğŸ‡¾', 'bo': 'ğŸ‡§ğŸ‡´', 'cr': 'ğŸ‡¨ğŸ‡·', 'pa': 'ğŸ‡µğŸ‡¦', 'gt': 'ğŸ‡¬ğŸ‡¹',
	'cu': 'ğŸ‡¨ğŸ‡º', 'do': 'ğŸ‡©ğŸ‡´', 'hn': 'ğŸ‡­ğŸ‡³', 'sv': 'ğŸ‡¸ğŸ‡»', 'ni': 'ğŸ‡³ğŸ‡®',
	'jm': 'ğŸ‡¯ğŸ‡²', 'tt': 'ğŸ‡¹ğŸ‡¹', 'bs': 'ğŸ‡§ğŸ‡¸', 'bb': 'ğŸ‡§ğŸ‡§', 'pr': 'ğŸ‡µğŸ‡·',
	
	# Africa
	'za': 'ğŸ‡¿ğŸ‡¦', 'eg': 'ğŸ‡ªğŸ‡¬', 'ng': 'ğŸ‡³ğŸ‡¬', 'ke': 'ğŸ‡°ğŸ‡ª', 'gh': 'ğŸ‡¬ğŸ‡­',
	'ma': 'ğŸ‡²ğŸ‡¦', 'dz': 'ğŸ‡©ğŸ‡¿', 'tn': 'ğŸ‡¹ğŸ‡³', 'et': 'ğŸ‡ªğŸ‡¹', 'tz': 'ğŸ‡¹ğŸ‡¿',
	'ug': 'ğŸ‡ºğŸ‡¬', 'zw': 'ğŸ‡¿ğŸ‡¼', 'ao': 'ğŸ‡¦ğŸ‡´', 'cm': 'ğŸ‡¨ğŸ‡²', 'ci': 'ğŸ‡¨ğŸ‡®',
	'cd': 'ğŸ‡¨ğŸ‡©', 'sn': 'ğŸ‡¸ğŸ‡³', 'ml': 'ğŸ‡²ğŸ‡±', 'bf': 'ğŸ‡§ğŸ‡«', 'ne': 'ğŸ‡³ğŸ‡ª',
	'tg': 'ğŸ‡¹ğŸ‡¬', 'bw': 'ğŸ‡§ğŸ‡¼', 'na': 'ğŸ‡³ğŸ‡¦', 'mz': 'ğŸ‡²ğŸ‡¿', 'mg': 'ğŸ‡²ğŸ‡¬',
	
	# Oceania
	'au': 'ğŸ‡¦ğŸ‡º', 'nz': 'ğŸ‡³ğŸ‡¿', 'fj': 'ğŸ‡«ğŸ‡¯', 'pg': 'ğŸ‡µğŸ‡¬', 'ws': 'ğŸ‡¼ğŸ‡¸',
	'to': 'ğŸ‡¹ğŸ‡´', 'vu': 'ğŸ‡»ğŸ‡º', 'sb': 'ğŸ‡¸ğŸ‡§', 'nc': 'ğŸ‡³ğŸ‡¨', 'pf': 'ğŸ‡µğŸ‡«',
	'gu': 'ğŸ‡¬ğŸ‡º', 'as': 'ğŸ‡¦ğŸ‡¸', 'ck': 'ğŸ‡¨ğŸ‡°', 'nu': 'ğŸ‡³ğŸ‡º', 'tk': 'ğŸ‡¹ğŸ‡°',
	
	# Caribbean & Atlantic
	'bm': 'ğŸ‡§ğŸ‡²', 'ky': 'ğŸ‡°ğŸ‡¾', 'vi': 'ğŸ‡»ğŸ‡®', 'ag': 'ğŸ‡¦ğŸ‡¬', 'dm': 'ğŸ‡©ğŸ‡²',
	'gd': 'ğŸ‡¬ğŸ‡©', 'kn': 'ğŸ‡°ğŸ‡³', 'lc': 'ğŸ‡±ğŸ‡¨', 'vc': 'ğŸ‡»ğŸ‡¨', 'ai': 'ğŸ‡¦ğŸ‡®',
	'ms': 'ğŸ‡²ğŸ‡¸', 'gp': 'ğŸ‡¬ğŸ‡µ', 'mq': 'ğŸ‡²ğŸ‡¶', 'gf': 'ğŸ‡¬ğŸ‡«', 'aw': 'ğŸ‡¦ğŸ‡¼',
	'cw': 'ğŸ‡¨ğŸ‡¼', 'sx': 'ğŸ‡¸ğŸ‡½', 'bq': 'ğŸ‡§ğŸ‡¶', 'tc': 'ğŸ‡¹ğŸ‡¨', 'vg': 'ğŸ‡»ğŸ‡¬',
	
	# Indian Ocean
	'mu': 'ğŸ‡²ğŸ‡º', 'sc': 'ğŸ‡¸ğŸ‡¨', 're': 'ğŸ‡·ğŸ‡ª', 'yt': 'ğŸ‡¾ğŸ‡¹', 'km': 'ğŸ‡°ğŸ‡²',
	'mv': 'ğŸ‡²ğŸ‡»', 'io': 'ğŸ‡®ğŸ‡´', 'cx': 'ğŸ‡¨ğŸ‡½', 'cc': 'ğŸ‡¨ğŸ‡¨', 'hm': 'ğŸ‡­ğŸ‡²',
	
	# Arctic & Antarctic
	'gl': 'ğŸ‡¬ğŸ‡±', 'fo': 'ğŸ‡«ğŸ‡´', 'sj': 'ğŸ‡¸ğŸ‡¯', 'ax': 'ğŸ‡¦ğŸ‡½', 'tf': 'ğŸ‡¹ğŸ‡«',
	'bv': 'ğŸ‡§ğŸ‡»', 'gs': 'ğŸ‡¬ğŸ‡¸', 'aq': 'ğŸ‡¦ğŸ‡¶', 'tf': 'ğŸ‡¹ğŸ‡«',
	
	# Special territories
	'eu': 'ğŸ‡ªğŸ‡º', 'un': 'ğŸ‡ºğŸ‡³', 'ac': 'ğŸ‡¦ğŸ‡¨', 'ta': 'ğŸ‡¹ğŸ‡¦', 'cp': 'ğŸ‡¨ğŸ‡µ',
	'dg': 'ğŸ‡©ğŸ‡¬', 'ea': 'ğŸ‡ªğŸ‡¦', 'ic': 'ğŸ‡®ğŸ‡¨', 'xk': 'ğŸ‡½ğŸ‡°'
}

export class Localization
	onready
	onerror
	onchange
	languages = {}
	preferred = (window..navigator..language || 'en-US').slice(0, 2)
	default
	ready = false
	err = {
		cache: {}
		throw: do(code, details)
			return if err.cache[code]
			if onerror isa Function and ready
				onerror(code, details)
			else
				console.log "Localization error:", code, details
			err.cache[code] = true
	}

	def constructor url, fallback = 'en'
		default = fallback
		window.fetch(url)
		.then(do(response) response.json!)
		.then(do(data) _finalize(data, undefined))
		.catch(do(error) _finalize(undefined, error))
		
		return new Proxy self, {
			get: do(target, p, receiver)
				if Reflect.has(target, p)
					return Reflect.get(target, p, receiver)
				if !target.ready
					target.err.throw("Request before localization is ready:", p)
					return
				return if target.err.cache[p]
				return target.languages[p] if target.languages[p]
				return target.languages[target.active][p] if target.languages[target.active] and target.languages[target.active][p]
				target.err.throw('localization-no-key', p)
				return ''
		}
				
	def _finalize data, error
		if error or !data
			err.throw('localization-no-file',error) 
		elif !data[default]
			err.throw('localization-no-default', default)
		else
			languages = data
			ready = true
			err.cache = {}
			onready! if onready isa Function
			onchange(active) if onchange isa Function

	get active
		const saved = window.localStorage.getItem('imba-localization')
		return saved if saved and languages[saved]
		return preferred if languages[preferred]
		return default 
	
	set active name
		name = name and languages[name] ? name : active
		if window.localStorage.getItem('imba-localization') != name
			window.localStorage.setItem('imba-localization', name)
			onchange(name) if onchange isa Function
			err.cache = {}

export const path-arrow-down = <path d="M213.66,165.66a8,8,0,0,1-11.32,0L128,91.31,53.66,165.66a8,8,0,0,1-11.32-11.32l80-80a8,8,0,0,1,11.32,0l80,80A8,8,0,0,1,213.66,165.66Z">

tag language-selector
	state
	#dropdown = false
	arrow = path-arrow-down
	passive = false
	first = true  # Show selected language first in dropdown

	def onselect key
		#dropdown = false
		data = key

	def flag language
		const settings = language.$
		if !settings
			state.err.throw('localization-no-key', '$')
			return 'ğŸŒ'
		const flag = settings.flag
		if !flag
			state.err.throw('localization-no-key', '$.flag')
			return 'ğŸŒ'
		# Return emoji flag
		return flags[flag] || 'ğŸŒ'

	def name language
		const settings = language.$
		if !settings
			state.err.throw('localization-no-key', '$')
			return undefined
		const name = settings.name
		if !name
			state.err.throw('localization-no-key', '$.name')
			return undefined
		return name

	def mouseleave e
		return if passive
		const rect = self.getBoundingClientRect!
		const menu = $menu.getBoundingClientRect!
		const inside = e.clientY >= menu.bottom || e.clientY <= rect.top || (e.clientX <= rect.left and e.clientY <= rect.bottom) || (e.clientX <= menu.left and e.clientY >= menu.top) || (e.clientX >= rect.right and e.clientY <= rect.bottom) || (e.clientX >= menu.right and e.clientY >= menu.top)
		#dropdown = !inside

	def mouseenter
		return if passive
		#dropdown = true

	def click
		return if !passive
		#dropdown = !#dropdown

	css
		$ease: 0.5s
		.container rd:8px px:15px py:8px bgc:light-dark(#000000/10, #FFFFFF/20) fw:500 fs:13px ead:$ease bd:1px solid transparent
			@.active bgc:light-dark(#000000/20, #FFFFFF/30) bd:1px solid transparent
		.flag mr:10px fs:20px lh:20px bd:1px solid transparent
		.name mr:10px bd:1px solid transparent
		.arrow w:16px h:16px fill:light-dark(#000000,#FFFFFF) ml:auto scale-y:-1 bd:1px solid transparent
			@.active scale-y:1 bd:1px solid transparent
		.menu t:100% l:50% x:-50% zi:999 backdrop-filter:blur(20px) mt:2px rd:8px rd:8px py:5px bgc:light-dark(#000000/5, #FFFFFF/10) fw:500 fs:13px ead:$ease bd:1px solid transparent
		.item d:hflex ai:center px:10px py:5px rd:8px cursor:pointer bg@hover:light-dark(#000000/10, #FFFFFF/20) m:5px bd:1px solid transparent
		.icon mr:10px fs:20px lh:20px bd:1px solid transparent
		.text fs:13px bd:1px solid transparent

	<self [pos:rel] @mouseenter=mouseenter @mouseleave=mouseleave @click=click>
			<global @click.outside=(do #dropdown = false)>
			<div.container [pos:rel d:hcc] .active=#dropdown [cursor:pointer]=(Object.keys(state.languages).length > 1)>
				<span.flag> flag(state.languages[data])
				<div.name> name(state.languages[data])
				if Object.keys(state.languages).length > 1
					<svg.arrow [ead:$ease] .active=#dropdown viewBox="0 0 256 256">
						<{arrow}>

			if #dropdown and Object.keys(state.languages).length > 1
				<div$menu.menu [pos:abs w:100% > max-content o@off:0] ease>
					# Current language first (if first is true)
					if first
						<div.item>
							<span.icon> flag(state.languages[data])
							<span.text> name(state.languages[data])
					# Other languages
					for own key, value of state.languages
						<div.item @click.trap=onselect(key) [d:none]=(key == data && first)>
							<span.icon> flag(value)
							<span.text> name(value)
